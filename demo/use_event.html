<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style>
        canvas{
            display: block;
            margin: 100px auto;
        }
    </style>
    <script src="../bin/flip.js"></script>
    <script src="../plugin/flip/EventPool.js"></script>
</head>
<body>
<canvas id="cvs" height="600" width="800"></canvas>
<script>
    Flip(function(){
       var cvs=Flip.$('#cvs'),ctx=cvs.getContext('2d'),eventPool=Flip.getEventPool(cvs),
               points=[],render=new Flip.Render(),achieve=[],levelRender=new Flip.Render();
        levelRender.render=function(state){
            var level=this.level;
            if(level){
                ctx.font='36px "微软雅黑"';
                ctx.fillText('level '+level,300,220);
            }
        };
        eventPool.onupdate= function (events) {
            events.filter(function(evt){return evt.eventType=='click'}).forEach(function (evt) {
                if(points.some(function(point,index){
                            pathCircle(point[0],point[1],ctx,30);
                            if(ctx.isPointInPath(evt.offsetX,evt.offsetY)){
                                if(!point[4])
                                {
                                    points[index]=null;
                                    achieve.push([point[0],point[1],rank(point[3])])
                                }
                                else point[4]=1;
                                render.invalid();
                                return true;
                            }
                        })){
                    points=points.filter(function (p) { return p; })
                }
            });
        };
        eventPool.skipFrameNum=0;
        Flip.instance.add(eventPool);
        Flip.instance.add(render);
        Flip.instance.add(levelRender);
        render.render= function () {
            paint(ctx);
        };
        loopAnimation(1);
        function loopAnimation(level){
          return Flip.animate({
              duration:1,
              once:{
                  init:function(){
                      levelRender.level=level;
                  },
                  finish:function(){
                      levelRender.level=0;
                  }
              }
          }).then(function(){
              return createPoint(level,600,400)
          }).then({
              duration:1,
              once:{
                  finish:function(){
                      points=[];
                      achieve=[];
                      loopAnimation(level+1)
                  }
              }
          })
        }
        function rank(percent){
            if(percent >.4) return 'MISS;;';
            else if(percent >.2) return 'OK~';
            else if(percent >.1) return 'Great!';
            else return 'Perfect ^^';
        }
        function paint(ctx){
            ctx.clearRect(0,0,800,600);
            ctx.save();
            ctx.fillStyle='red';
            ctx.lineWidth=2;
            ctx.font='20px "微软雅黑"';
            points.forEach(function(point){
                var dead=point[4],percent=point[3];
                pathCircle(point[0],point[1],ctx,30);
                ctx.fillStyle=dead? '#333':'yellow';
                ctx.fill();
                ctx.fillStyle='orange';
                ctx.fillText(point[2],point[0]-5,point[1]+5);
                if(!dead&& point[5]){
                    pathCircle(point[0],point[1],ctx,30*(1+percent));
                    ctx.stroke();
                }
            });
            ctx.fillStyle='black';
            achieve.forEach(function(point){
                ctx.fillText(point[2],point[0],point[1]);
            });
            ctx.restore();
        }
        function pathCircle(x,y,ctx,radius){
            ctx.beginPath();
            ctx.arc(x,y,radius,0,Math.PI*2);
            ctx.closePath();
        }
        function createPoint(num,width,height){
            for(var i= 0,sx= 0,point,animations=[],dx=width/num;i<num;i++)
            {
                points.push(point=[random(sx,sx+dx),random(0,height),i+1]);
                animations.push(createCircle((i+Math.random()),.7,point));
                sx+=dx;
            }
            return animations;
            function createCircle(delay,dur,point){
               // point[2]=0;
               return Flip.animate({
                    duration:dur,
                    delay:delay,
                    once:{
                      start: function () {
                          point[5]=1;
                      }
                    },
                    on:{
                        update: function () {
                            point[3]=(1-this.percent)
                        },
                        finish:function(){
                            point[4]=1;
                        }
                    }
                })
            }
        }
        function random(min,max){
            return Math.round(min+Math.random()*(max-min))
        }
    });
</script>
</body>
</html>